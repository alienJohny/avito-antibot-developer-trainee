# avito-antibot-developer-trainee

Artur Yumaev

art.yumaev@gmail.com


### Token-Bucket

Для решения задачи я использую алгоритм Token-Bucket.

![token-bucket](https://hsto.org/storage2/ddb/356/519/ddb356519393b8a96f9352ad4a2d4c32.png)

*Рис. 1. Визуализация работы алгоритма Token Bucket*

Клиенты могут быстро израсходовать свой лимит запросов, либо оставаться в пределах ограничений. На рис. 1 показано, что клиент А быстро израсходовал лимит и в данный момент находится в стадии ожидания, но запросы больше не отправлял. Клиент Б остается в рамках ограниений. Клиент В превысил лимит и снова пытался получить доступ. После ожидания, получил доступ и снова быстро превысил лимит.

### Redis

Для решения задачи я использую in-memory базу данных Redis.
Установить ее можно следующим образом.


```shell
$ wget http://download.redis.io/releases/redis-5.0.8.tar.gz
$ tar xzf redis-5.0.8.tar.gz
$ cd redis-5.0.8
$ make

$ src/redis-server
```

Также нужно установить redis-sever и запустить если он не был запущен
```
$ sudo apt-get install redis-server
$ redis-server
```

Установить вспомогательный модуль для flask

```
$ sudo apt install python3-flask
```

### Docker

Для запуска в docker контейнере:
```
$ sudo docker-compose build
$ sudo docker-compose up
```

### Дополнительные задачи

1. Возможность запустить с помощью docker-compose up :white_check_mark:
2. Лимит и время ожидания можно задавать при старте сервиса
   
   Если проект запускается через docker-compose,
   параметры сервиса можно указать в файле `Dockerfile`
   в последней строке:

   ```
   CMD ./run.sh 100 60 120
   ```

   Аргументы `./run.sh`:
   
   * Первый аргумент - количество запросов

   * Второй аргумент - диапозон времени в секундах, в рамках которого будет стоять ограничение на количество запросов

   * Третий аргумент - время ожидания в секундах после ограничения

   Приведенная команда выше означает, что у клиентов установлен лимит на 100 запросов в минуту (60 сек). Если лимит превышен, ожидание составит 2 минуты (120 сек).

3. Отдельный handler для сброса лимита по префиксу :white_check_mark:
   
   Это можно сделать через скрипт `reset_ip.sh`. Он принимает один аргумент - подсеть без кавычек.

   Например, для подсети `123.45.67` требуется снять ограничение на количество запросов. Тогда следует запустить

   ```reset_ip.sh 123.45.67```

   После этого, в конфигурационный файл `unlimAccessNetworks.ini` будет занесена информация о том, что на данную подсеть ограничения не действуют и данная информация будет учитываться при входящих запросах.

   Скрипт можно запускать в любой момент при работающем сервере.

### Если проект запускается не через docker

В этом случае в файле `redisTools.py` в третьей строке

```python
r = redis.Redis(host='redis', port=6379, db=0)
```

нужно изменить значение константы `host` на `'localhost'`.

В итоге строчка должны выглядеть вот так:

```python
r = redis.Redis(host='localhost', port=6379, db=0)
```

Далее запуск проект через скрипт `run.sh` параметрами, описанными выше.